{% extends "base.html" %}

{% block title %}Model Metrics - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_training') }}">Training</a></li>
                    <li class="breadcrumb-item active">Model Metrics</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-chart-bar"></i> Model Performance Metrics</h2>
                    {% if latest_checkpoint_results and latest_checkpoint_results.get('evaluation_date') %}
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Last COCO evaluation: {{ latest_checkpoint_results.get('evaluation_date').strftime('%Y-%m-%d %H:%M:%S') }}
                    </small>
                    {% else %}
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i> No COCO evaluation data available
                    </small>
                    {% endif %}
                </div>
                <div>
                    <form method="POST" action="{{ url_for('admin_evaluate_checkpoint') }}" class="d-inline">
                        <button type="submit" class="btn btn-warning me-2" onclick="return confirm('This will evaluate the checkpoint model on the COCO dataset. Continue?')">
                            <i class="fas fa-play"></i> Re-evaluate Checkpoint on COCO
                        </button>
                    </form>
                    <a href="{{ url_for('admin_training') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Training
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkpoint Model Evaluation Results -->
    {% if latest_checkpoint_results and latest_checkpoint_results.get('num_samples', 0) > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-brain"></i> Checkpoint Model - COCO Dataset Evaluation 
                        <span class="badge bg-light text-success ms-2">Auto-Evaluated on Startup</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-success">{{ "%.1f"|format(latest_checkpoint_results.get('accuracy', 0) * 100) }}%</h4>
                                <small class="text-muted">Accuracy</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-primary">{{ "%.3f"|format(latest_checkpoint_results.get('f1_weighted', 0)) }}</h4>
                                <small class="text-muted">F1 (Weighted)</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-info">{{ "%.3f"|format(latest_checkpoint_results.get('f1_macro', 0)) }}</h4>
                                <small class="text-muted">F1 (Macro)</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-warning">{{ "%.3f"|format(latest_checkpoint_results.get('avg_confidence', 0)) }}</h4>
                                <small class="text-muted">Avg Confidence</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-secondary">{{ "%.3f"|format(latest_checkpoint_results.get('avg_processing_time', 0)) }}s</h4>
                                <small class="text-muted">Avg Processing Time</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-dark">{{ "%.0f"|format(latest_checkpoint_results.get('num_samples', 0)) }}</h4>
                                <small class="text-muted">Samples Evaluated</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Key Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.1f"|format(object_summary.get('accuracy', {}).get('average', 0) * 100) }}%</h4>
                            <p class="mb-0">Accuracy</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bullseye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('macro_f1', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Macro F1 Score</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('micro_f1', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Micro F1 Score</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('mean_average_precision', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Mean Average Precision</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('weighted_f1', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Weighted F1 Score</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-balance-scale fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('precision_at_5', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Precision@5</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list-ol fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.3f"|format(object_summary.get('recall_at_5', {}).get('average', 0)) }}</h4>
                            <p class="mb-0">Recall@5</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Object Detection Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-eye"></i> Object Detection Metrics</h5>
                </div>
                <div class="card-body">
                    {% if object_summary %}
                        <div class="row mb-4">
                            {% for metric_name, stats in object_summary.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ metric_name.replace('_', ' ').title() }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-3">
                                                <h6 class="text-primary">{{ "%.3f"|format(stats.average) }}</h6>
                                                <small class="text-muted">Avg</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-success">{{ "%.3f"|format(stats.max) }}</h6>
                                                <small class="text-muted">Max</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-danger">{{ "%.3f"|format(stats.min) }}</h6>
                                                <small class="text-muted">Min</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-info">{{ stats.count }}</h6>
                                                <small class="text-muted">Count</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% if object_metrics %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                        <th>Class</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metric in object_metrics %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ metric.metric_name.replace('_', ' ').title() }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ "%.3f"|format(metric.metric_value) }}</strong>
                                        </td>
                                        <td>
                                            {% if metric.class_name %}
                                                <span class="badge bg-secondary">{{ metric.class_name }}</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ metric.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No object detection metrics available.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Text Analysis Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-font"></i> Text Analysis Metrics</h5>
                </div>
                <div class="card-body">
                    {% if text_summary %}
                        <div class="row mb-4">
                            {% for metric_name, stats in text_summary.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-info">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ metric_name.replace('_', ' ').title() }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-3">
                                                <h6 class="text-info">{{ "%.3f"|format(stats.average) }}</h6>
                                                <small class="text-muted">Avg</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-success">{{ "%.3f"|format(stats.max) }}</h6>
                                                <small class="text-muted">Max</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-danger">{{ "%.3f"|format(stats.min) }}</h6>
                                                <small class="text-muted">Min</small>
                                            </div>
                                            <div class="col-3">
                                                <h6 class="text-info">{{ stats.count }}</h6>
                                                <small class="text-muted">Count</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% if text_metrics %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                        <th>Class</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metric in text_metrics %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-info">{{ metric.metric_name.replace('_', ' ').title() }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ "%.3f"|format(metric.metric_value) }}</strong>
                                        </td>
                                        <td>
                                            {% if metric.class_name %}
                                                <span class="badge bg-secondary">{{ metric.class_name }}</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ metric.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No text analysis metrics available.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Per-Class F1 Scores -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tags"></i> Per-Class F1 Scores</h5>
                </div>
                <div class="card-body">
                    {% set class_f1_metrics = object_metrics | selectattr('metric_name', 'equalto', 'class_f1') | list %}
                    {% if class_f1_metrics %}
                        <div class="row">
                            {% for metric in class_f1_metrics %}
                            <div class="col-md-3 mb-3">
                                <div class="card border-{{ 'success' if metric.metric_value > 0.7 else 'warning' if metric.metric_value > 0.5 else 'danger' }}">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">{{ metric.class_name.replace('_', ' ').title() }}</h6>
                                        <h4 class="text-{{ 'success' if metric.metric_value > 0.7 else 'warning' if metric.metric_value > 0.5 else 'danger' }}">
                                            {{ "%.3f"|format(metric.metric_value) }}
                                        </h4>
                                        <small class="text-muted">F1 Score</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No per-class F1 scores available. Run model evaluation to generate these metrics.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Trends -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Understanding the Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Key Performance Indicators:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>Accuracy:</strong> Overall correctness (0-100%)</li>
                            <li><strong>Macro F1:</strong> Average F1 across all classes</li>
                            <li><strong>Micro F1:</strong> Global precision/recall balance</li>
                            <li><strong>Weighted F1:</strong> F1 weighted by class support</li>
                            <li><strong>MAP:</strong> Mean Average Precision for retrieval</li>
                            <li><strong>Precision@5:</strong> Precision in top 5 results</li>
                            <li><strong>Recall@5:</strong> Recall in top 5 results</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Performance Guidelines</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Good Performance Targets:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>Accuracy:</strong> > 85%</li>
                            <li><strong>Macro F1:</strong> > 0.80</li>
                            <li><strong>Micro F1:</strong> > 0.80</li>
                            <li><strong>MAP:</strong> > 0.70</li>
                            <li><strong>Per-class F1:</strong> > 0.70 for each class</li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>When to Retrain:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Accuracy drops below 80%</li>
                            <li>F1 scores consistently below 0.70</li>
                            <li>Large performance gaps between classes</li>
                            <li>User feedback indicates systematic errors</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}

.badge {
    font-size: 0.8em;
}
</style>
{% endblock %} 