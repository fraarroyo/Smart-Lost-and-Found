{% extends "base.html" %}

{% block title %}Admin - User Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-people me-2"></i>User Management</h2>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-person-plus me-1"></i>Add User
                    </button>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- User Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ users|length }}</h4>
                                    <p class="card-text">Total Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-people fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ users|selectattr('is_admin', 'equalto', true)|list|length }}</h4>
                                    <p class="card-text">Admin Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-shield-check fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ users|selectattr('is_guest', 'equalto', true)|list|length }}</h4>
                                    <p class="card-text">Guest Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-person-circle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ users|selectattr('is_guest', 'equalto', false)|selectattr('is_admin', 'equalto', false)|list|length }}</h4>
                                    <p class="card-text">Regular Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-person fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="userFilter">
                                <option value="">All Users</option>
                                <option value="admin">Admin Users</option>
                                <option value="regular">Regular Users</option>
                                <option value="guest">Guest Users</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="sortBy">
                                <option value="username">Sort by Username</option>
                                <option value="email">Sort by Email</option>
                                <option value="date_joined">Sort by Join Date</option>
                                <option value="last_login">Sort by Last Login</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-table me-2"></i>Users List</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Date Joined</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" data-user-type="{% if user.is_admin %}admin{% elif user.is_guest %}guest{% else %}regular{% endif %}">
                                    <td>{{ user.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                {{ user.username[0].upper() }}
                                            </div>
                                            <div>
                                                <strong>{{ user.username }}</strong>
                                                {% if user.is_admin %}
                                                    <span class="badge bg-danger ms-1">Admin</span>
                                                {% elif user.is_guest %}
                                                    <span class="badge bg-info ms-1">Guest</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.email %}
                                            {{ user.email }}
                                        {% else %}
                                            <span class="text-muted">No email</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_admin %}
                                            <span class="badge bg-danger">Administrator</span>
                                        {% elif user.is_guest %}
                                            <span class="badge bg-info">Guest</span>
                                        {% else %}
                                            <span class="badge bg-success">Regular</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.date_joined %}
                                            {{ user.date_joined.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                            {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewUser({{ user.id }})" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if not user.is_admin or user.id != current_user.id %}
                                                <button class="btn btn-sm btn-outline-warning" onclick="editUser({{ user.id }})" title="Edit User">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                {% if user.is_active %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="toggleUserStatus({{ user.id }}, false)" title="Deactivate">
                                                        <i class="bi bi-person-x"></i>
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-success" onclick="toggleUserStatus({{ user.id }}, true)" title="Activate">
                                                        <i class="bi bi-person-check"></i>
                                                    </button>
                                                {% endif %}
                                                {% if not user.is_admin %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})" title="Delete User">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin">
                            <label class="form-check-label" for="is_admin">
                                Administrator
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="edit_username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit_email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="edit_password" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="edit_password" name="password">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_admin" name="is_admin">
                            <label class="form-check-label" for="edit_is_admin">
                                Administrator
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 14px;
}

.table th {
    border-top: none;
}

.btn-group .btn {
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}
</style>

<script>
// Search and filter functionality
document.getElementById('userSearch').addEventListener('input', filterUsers);
document.getElementById('userFilter').addEventListener('change', filterUsers);
document.getElementById('sortBy').addEventListener('change', sortUsers);

function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const filterType = document.getElementById('userFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const username = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const userType = row.getAttribute('data-user-type');
        
        const matchesSearch = username.includes(searchTerm) || email.includes(searchTerm);
        const matchesFilter = !filterType || userType === filterType;
        
        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
}

function sortUsers() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.querySelector('#usersTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(sortBy) {
            case 'username':
                aVal = a.cells[1].textContent.trim();
                bVal = b.cells[1].textContent.trim();
                break;
            case 'email':
                aVal = a.cells[2].textContent.trim();
                bVal = b.cells[2].textContent.trim();
                break;
            case 'date_joined':
                aVal = a.cells[5].textContent.trim();
                bVal = b.cells[5].textContent.trim();
                break;
            case 'last_login':
                aVal = a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim();
                break;
            default:
                return 0;
        }
        
        return aVal.localeCompare(bVal);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

// User management functions
function viewUser(userId) {
    console.log('Viewing user ID:', userId);
    fetch(`/admin/users/${userId}`)
        .then(response => {
            console.log('View user response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('View user data:', data);
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            const userDetails = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Username:</strong> ${data.username}</p>
                        <p><strong>Email:</strong> ${data.email || 'No email'}</p>
                        <p><strong>Type:</strong> ${data.is_admin ? 'Administrator' : data.is_guest ? 'Guest' : 'Regular'}</p>
                        <p><strong>Status:</strong> ${data.is_active ? 'Active' : 'Inactive'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Account Information</h6>
                        <p><strong>Date Joined:</strong> ${data.date_joined || 'Unknown'}</p>
                        <p><strong>Last Login:</strong> ${data.last_login || 'Never'}</p>
                        <p><strong>User ID:</strong> ${data.id}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = userDetails;
            new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error loading user details:', error);
            alert('Error loading user details');
        });
}

function editUser(userId) {
    console.log('Editing user ID:', userId);
    fetch(`/admin/users/${userId}`)
        .then(response => {
            console.log('Edit user response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Edit user data:', data);
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            document.getElementById('edit_user_id').value = data.id;
            document.getElementById('edit_username').value = data.username;
            document.getElementById('edit_email').value = data.email || '';
            document.getElementById('edit_is_admin').checked = data.is_admin;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            alert('Error loading user data');
        });
}

function toggleUserStatus(userId, activate) {
    console.log('Toggling user status for ID:', userId, 'activate:', activate);
    if (confirm(`Are you sure you want to ${activate ? 'activate' : 'deactivate'} this user?`)) {
        fetch(`/admin/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ activate: activate })
        })
        .then(response => {
            console.log('Toggle status response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Toggle status data:', data);
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error updating user status:', error);
            alert('Error updating user status: ' + error.message);
        });
    }
}

function deleteUser(userId) {
    console.log('Deleting user ID:', userId);
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => {
            console.log('Delete user response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete user data:', data);
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            alert('Error deleting user: ' + error.message);
        });
    }
}

// Form submissions
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.is_admin = document.getElementById('is_admin').checked;
    
    fetch('/admin/users/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding user: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error adding user:', error);
        alert('Error adding user');
    });
});

document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.is_admin = document.getElementById('edit_is_admin').checked;
    
    const userId = data.user_id;
    delete data.user_id;
    
    fetch(`/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating user: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating user:', error);
        alert('Error updating user');
    });
});
</script>
{% endblock %}