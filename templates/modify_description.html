{% extends "base.html" %}

{% block title %}Modify Description - {{ item.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>Modify Item Description
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            {% if item.image_path %}
                            <img src="{{ url_for('static', filename=item.image_path) }}" 
                                 class="img-fluid rounded" alt="{{ item.title }}" 
                                 style="max-height: 200px; object-fit: cover;">
                            {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                 style="height: 200px;">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h5 class="fw-bold">{{ item.title }}</h5>
                            <p class="text-muted mb-2">
                                <i class="bi bi-tag me-1"></i>{{ item.category.title() }}
                                <span class="badge bg-{{ 'danger' if item.status == 'lost' else 'success' }} ms-2">
                                    {{ item.status.title() }}
                                </span>
                            </p>
                            <p class="text-muted mb-0">
                                <i class="bi bi-geo-alt me-1"></i>{{ item.location }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description Modification Form -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-text me-2"></i>Current Description
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="descriptionForm">
                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">
                                <i class="bi bi-pencil me-1"></i>Item Description
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="6" required 
                                      placeholder="Enter a detailed description of the item...">{{ item.description }}</textarea>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Provide a detailed description that will help others identify this item. 
                                Include specific features, colors, brand, model, or any distinctive characteristics.
                            </div>
                        </div>

                        <!-- Description Tips -->
                        <div class="alert alert-info">
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-lightbulb me-2"></i>Description Tips
                            </h6>
                            <ul class="mb-0">
                                <li><strong>Be specific:</strong> Include brand, model, color, size, and material</li>
                                <li><strong>Mention unique features:</strong> Scratches, stickers, engravings, or distinctive marks</li>
                                <li><strong>Include condition:</strong> New, used, worn, damaged, etc.</li>
                                <li><strong>Add context:</strong> Where it was found/lost, any accessories included</li>
                                <li><strong>Use keywords:</strong> Include terms others might search for</li>
                            </ul>
                        </div>

                        <!-- Quick Actions -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addKeywordsBtn">
                                    <i class="bi bi-tags me-1"></i>Add Keywords
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm ms-2" id="improveBtn">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Improve
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="previewBtn">
                                    <i class="bi bi-eye me-1"></i>Preview
                                </button>
                            </div>
                        </div>

                        <!-- Character Count -->
                        <div class="mb-3">
                            <small class="text-muted">
                                <span id="charCount">0</span> characters
                                <span class="ms-3">
                                    <span id="wordCount">0</span> words
                                </span>
                            </small>
                        </div>

                        <!-- Original AI Description (if available) -->
                        {% if original_description and original_description != item.description %}
                        <div class="alert alert-light border">
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-robot me-2"></i>Original AI Description
                                <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#originalDesc" aria-expanded="false">
                                    <i class="bi bi-eye me-1"></i>Show/Hide
                                </button>
                            </h6>
                            <div class="collapse" id="originalDesc">
                                <p class="text-muted mb-2">{{ original_description }}</p>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="restoreOriginal()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Restore Original
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                <i class="bi bi-check-circle me-1"></i>Save Changes
                            </button>
                            <a href="{{ url_for('view_item', item_id=item.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Cancel
                            </a>
                            <button type="button" class="btn btn-outline-info" id="suggestBtn">
                                <i class="bi bi-magic me-1"></i>AI Suggestions
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AI Suggestions Modal -->
            <div class="modal fade" id="suggestionsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-magic me-2"></i>AI Description Suggestions
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="suggestionsContent">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading suggestions...</span>
                                    </div>
                                    <p class="mt-2">Generating AI suggestions...</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const descriptionTextarea = document.getElementById('description');
    const charCount = document.getElementById('charCount');
    const wordCount = document.getElementById('wordCount');
    const saveBtn = document.getElementById('saveBtn');
    const suggestBtn = document.getElementById('suggestBtn');
    const suggestionsModal = new bootstrap.Modal(document.getElementById('suggestionsModal'));

    // Character and word counting
    function updateCounts() {
        const text = descriptionTextarea.value;
        const chars = text.length;
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        
        charCount.textContent = chars;
        wordCount.textContent = words;
        
        // Visual feedback for length
        if (chars < 50) {
            charCount.className = 'text-warning';
        } else if (chars < 200) {
            charCount.className = 'text-info';
        } else {
            charCount.className = 'text-success';
        }
    }

    descriptionTextarea.addEventListener('input', updateCounts);
    updateCounts(); // Initial count

    // Form validation
    const form = document.getElementById('descriptionForm');
    form.addEventListener('submit', function(e) {
        const description = descriptionTextarea.value.trim();
        
        if (!description) {
            e.preventDefault();
            alert('Please enter a description.');
            descriptionTextarea.focus();
            return;
        }
        
        if (description.length < 10) {
            e.preventDefault();
            alert('Description must be at least 10 characters long.');
            descriptionTextarea.focus();
            return;
        }
        
        // Show loading state
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        saveBtn.disabled = true;
    });

    // AI Suggestions
    suggestBtn.addEventListener('click', function() {
        suggestionsModal.show();
        
        // Generate suggestions (placeholder for now)
        setTimeout(() => {
            const suggestionsContent = document.getElementById('suggestionsContent');
            suggestionsContent.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle me-2"></i>AI Suggestions</h6>
                    <p>Based on the item image and category, here are some suggestions to improve your description:</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Enhanced Description</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Add specific details about the item's condition, brand, and distinctive features.</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="applySuggestion('enhanced')">Use This</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Detailed Features</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Include material, color variations, size, and any unique characteristics.</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="applySuggestion('detailed')">Use This</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> These are general suggestions. Please customize them based on your specific item.
                </div>
            `;
        }, 1500);
    });

    // Quick Actions
    document.getElementById('addKeywordsBtn').addEventListener('click', function() {
        const currentText = descriptionTextarea.value;
        const keywords = prompt('Enter keywords to add (separated by commas):');
        if (keywords && keywords.trim()) {
            const keywordList = keywords.split(',').map(k => k.trim()).filter(k => k);
            const newText = currentText + ' Keywords: ' + keywordList.join(', ');
            descriptionTextarea.value = newText;
            updateCounts();
        }
    });

    document.getElementById('improveBtn').addEventListener('click', function() {
        const currentText = descriptionTextarea.value;
        if (currentText.length < 20) {
            alert('Please write a longer description before using the improve feature.');
            return;
        }
        
        // Simple improvement suggestions
        let improved = currentText;
        
        // Add condition if not mentioned
        if (!improved.toLowerCase().includes('condition') && !improved.toLowerCase().includes('used') && !improved.toLowerCase().includes('new')) {
            improved += ' The item appears to be in good condition.';
        }
        
        // Add size if not mentioned
        if (!improved.toLowerCase().includes('size') && !improved.toLowerCase().includes('small') && !improved.toLowerCase().includes('large')) {
            improved += ' Size details not specified.';
        }
        
        // Add material if not mentioned
        if (!improved.toLowerCase().includes('material') && !improved.toLowerCase().includes('plastic') && !improved.toLowerCase().includes('metal') && !improved.toLowerCase().includes('fabric')) {
            improved += ' Material not specified.';
        }
        
        descriptionTextarea.value = improved;
        updateCounts();
    });

    document.getElementById('previewBtn').addEventListener('click', function() {
        const description = descriptionTextarea.value;
        if (!description.trim()) {
            alert('Please enter a description to preview.');
            return;
        }
        
        // Create preview modal
        const previewModal = document.createElement('div');
        previewModal.className = 'modal fade';
        previewModal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Description Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>How your description will appear:</h6>
                        <div class="border p-3 rounded bg-light">
                            <p class="mb-0">${description.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Length:</strong> ${description.length} characters, ${description.trim().split(/\s+/).length} words
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(previewModal);
        const modal = new bootstrap.Modal(previewModal);
        modal.show();
        
        // Clean up when modal is hidden
        previewModal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(previewModal);
        });
    });

    // Auto-resize textarea
    descriptionTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Auto-save draft (optional)
    let saveTimeout;
    descriptionTextarea.addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            localStorage.setItem('description_draft_' + {{ item.id }}, this.value);
        }, 2000);
    });

    // Load draft on page load
    const draft = localStorage.getItem('description_draft_' + {{ item.id }});
    if (draft && draft !== descriptionTextarea.value) {
        if (confirm('You have a saved draft. Would you like to load it?')) {
            descriptionTextarea.value = draft;
            updateCounts();
        }
    }

    // Clear draft on successful save
    form.addEventListener('submit', function() {
        localStorage.removeItem('description_draft_' + {{ item.id }});
    });
});

// Global function for applying suggestions
function applySuggestion(type) {
    const textarea = document.getElementById('description');
    const currentText = textarea.value;
    
    let suggestion = '';
    switch(type) {
        case 'enhanced':
            suggestion = currentText + ' The item is in good condition with no visible damage.';
            break;
        case 'detailed':
            suggestion = currentText + ' Features include high-quality materials and distinctive design elements.';
            break;
    }
    
    textarea.value = suggestion;
    textarea.focus();
    
    // Update counts
    const event = new Event('input');
    textarea.dispatchEvent(event);
}
</script>
{% endblock %}
